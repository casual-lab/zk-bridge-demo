# 跨链桥分阶段开发计划

## 总体原则

1. **每个阶段完成一个可独立测试的模块**
2. **先实现核心功能，再优化性能**
3. **每个阶段都有明确的验收标准**
4. **逐步集成，降低集成风险**

---

## Phase 1: Solana 单链核心功能 (Week 1-2)

### 目标
实现 Solana 侧的基础跨链合约，完成代币锁定、解锁、超时回滚等核心逻辑。

### 任务清单

#### 1.1 项目初始化 (Day 1)
- [ ] 创建 Anchor 项目
- [ ] 配置 Solana 开发环境
- [ ] 定义数据结构（BridgeConfig, TokenConfig, TransferOrder）
- [ ] 编写基础测试框架

**验收标准**：
- `anchor init` 成功
- 编译通过
- 基础测试可运行

#### 1.2 代币锁定功能 (Day 2-3)
- [ ] 实现 `initialize_bridge` 指令
- [ ] 实现 `register_token_pair` 指令
- [ ] 实现 `lock_tokens` 指令（原生 Solana 代币）
- [ ] 编写单元测试

**验收标准**：
- 用户可以锁定 SPL Token
- 订单状态正确创建（Pending）
- 余额正确扣减
- 事件正确发出

#### 1.3 代币解锁功能 (Day 4-5)
- [ ] 实现 `unlock_tokens` 指令
- [ ] 模拟 ZK 证明验证（暂时跳过真实验证）
- [ ] 实现状态机转换（Pending → Completed）
- [ ] 编写单元测试

**验收标准**：
- 提供正确的 order_id 可以解锁代币
- 订单状态正确更新
- 防止重复解锁
- 代币正确转移给接收者

#### 1.4 超时回滚功能 (Day 6-7)
- [ ] 实现 `refund_timeout` 指令
- [ ] 实现超时检查逻辑（slot 计数）
- [ ] 实现状态机转换（Pending → Refunded）
- [ ] 编写边界测试

**验收标准**：
- 超时前无法退款
- 超时后用户可以成功退款
- 已完成的订单无法退款
- 已退款的订单无法重复退款

#### 1.5 集成测试 (Day 8-9)
- [ ] 编写端到端测试：锁定 → 解锁流程
- [ ] 编写端到端测试：锁定 → 超时 → 退款流程
- [ ] 编写并发测试
- [ ] 编写异常场景测试

**验收标准**：
- 所有测试通过
- 代码覆盖率 > 80%

#### 1.6 代币销毁/铸造功能 (Day 10)
- [ ] 实现 `burn_tokens` 指令（外来代币）
- [ ] 实现 `mint_tokens` 指令（外来代币）
- [ ] 编写测试

**验收标准**：
- 支持双向跨链（Lock/Unlock + Burn/Mint）
- 测试覆盖两种模式

---

## Phase 2: EVM 单链核心功能 (Week 3-4)

### 目标
实现 EVM 侧的跨链合约，与 Solana 侧功能对称。

### 任务清单

#### 2.1 项目初始化 (Day 11)
- [ ] 创建 Hardhat 项目
- [ ] 配置 Solidity 环境
- [ ] 定义合约结构和数据类型
- [ ] 编写基础测试框架

**验收标准**：
- `npx hardhat init` 成功
- 编译通过
- 基础测试可运行

#### 2.2 代币锁定功能 (Day 12-13)
- [ ] 实现 `initializeBridge` 函数
- [ ] 实现 `registerTokenPair` 函数
- [ ] 实现 `lockTokens` 函数
- [ ] 编写单元测试

**验收标准**：
- 用户可以锁定 ERC-20
- 订单状态正确创建
- 余额正确扣减
- 事件正确发出

#### 2.3 代币解锁功能 (Day 14-15)
- [ ] 实现 `unlockTokens` 函数
- [ ] 模拟 ZK 证明验证（暂时跳过）
- [ ] 实现状态机转换
- [ ] 编写单元测试

**验收标准**：
- 提供正确的 orderId 可以解锁代币
- 订单状态正确更新
- 防止重复解锁

#### 2.4 超时回滚功能 (Day 16-17)
- [ ] 实现 `refundTimeout` 函数
- [ ] 实现超时检查逻辑（block 计数）
- [ ] 实现状态机转换
- [ ] 编写边界测试

**验收标准**：
- 超时逻辑正确
- 状态机防护正确

#### 2.5 集成测试 (Day 18-19)
- [ ] 编写端到端测试
- [ ] 编写并发测试
- [ ] 编写异常场景测试

**验收标准**：
- 所有测试通过
- 代码覆盖率 > 80%

#### 2.6 代币销毁/铸造功能 (Day 20)
- [ ] 实现 `burnTokens` 函数
- [ ] 实现 `mintTokens` 函数
- [ ] 编写测试

**验收标准**：
- 支持双向跨链

---

## Phase 3: SP1 zkVM 证明系统 (Week 5-6)

### 目标
开发 SP1 zkVM Guest Program，实现跨链状态证明生成和验证。

### 任务清单

#### 3.1 开发环境搭建 (Day 21)
- [ ] 安装 SP1 SDK
- [ ] 创建 SP1 项目
- [ ] 编写 Hello World Guest Program
- [ ] 测试证明生成和验证

**验收标准**：
- SP1 环境正常运行
- 可以生成和验证简单证明

#### 3.2 Merkle 证明验证模块 (Day 22-23)
- [ ] 实现 Merkle 树哈希计算
- [ ] 实现 Merkle 证明验证逻辑
- [ ] 编写单元测试

**验收标准**：
- 可以验证 Merkle 证明的正确性
- 错误的证明会被拒绝

#### 3.3 Solana 状态验证 Guest Program (Day 24-26)
- [ ] 实现 Solana 账户数据解析
- [ ] 实现状态根验证
- [ ] 实现订单状态检查
- [ ] 实现时间窗口验证
- [ ] 编写测试

**验收标准**：
- Guest Program 可以正确验证 Solana 订单状态
- 输出正确的公开数据
- 伪造数据会导致验证失败

#### 3.4 EVM 状态验证 Guest Program (Day 27-29)
- [ ] 实现 EVM Storage Proof 验证
- [ ] 实现 Event Log 验证
- [ ] 实现订单状态检查
- [ ] 编写测试

**验收标准**：
- Guest Program 可以正确验证 EVM 订单状态
- 输出正确的公开数据

#### 3.5 Host Program 开发 (Day 30)
- [ ] 实现从 Solana RPC 获取数据
- [ ] 实现从 EVM RPC 获取数据
- [ ] 实现证明生成流程
- [ ] 编写集成测试

**验收标准**：
- 可以从本地测试链获取数据
- 可以生成有效证明

---

## Phase 4: 轻客户端实现 (Week 7)

### 目标
实现轻客户端，用于验证状态根的有效性。

### 任务清单

#### 4.1 Solana 轻客户端 (EVM 侧) (Day 31-33)
- [ ] 设计状态根提交机制
- [ ] 实现验证器签名验证
- [ ] 实现状态根存储
- [ ] 编写测试

**验收标准**：
- 可以提交和验证 Solana 状态根
- 拒绝无效签名

#### 4.2 EVM 轻客户端 (Solana 侧) (Day 34-35)
- [ ] 设计状态根提交机制
- [ ] 实现区块头验证
- [ ] 实现状态根存储
- [ ] 编写测试

**验收标准**：
- 可以提交和验证 EVM 状态根
- 拒绝无效区块头

---

## Phase 5: 集成 ZK 验证到智能合约 (Week 8)

### 目标
将 SP1 验证器集成到智能合约，实现真正的 ZK 证明验证。

### 任务清单

#### 5.1 部署 SP1 Verifier (Day 36-37)
- [ ] 部署 SP1 Verifier 到 Solana
- [ ] 部署 SP1 Verifier 到 EVM
- [ ] 测试基础验证功能

**验收标准**：
- Verifier 合约正确部署
- 可以验证测试证明

#### 5.2 集成到 Solana Program (Day 38-39)
- [ ] 修改 `unlock_tokens` 调用 SP1 Verifier
- [ ] 修改 `mint_tokens` 调用 SP1 Verifier
- [ ] 编写集成测试

**验收标准**：
- 只接受有效的 ZK 证明
- 拒绝无效证明

#### 5.3 集成到 EVM Contract (Day 40-41)
- [ ] 修改 `unlockTokens` 调用 SP1 Verifier
- [ ] 修改 `mintTokens` 调用 SP1 Verifier
- [ ] 编写集成测试

**验收标准**：
- 只接受有效的 ZK 证明
- 拒绝无效证明

#### 5.4 集成轻客户端验证 (Day 42)
- [ ] 在 mint/unlock 函数中添加状态根检查
- [ ] 编写测试

**验收标准**：
- 拒绝未经轻客户端确认的状态根

---

## Phase 6: Relayer 服务开发 (Week 9-10)

### 目标
开发链下 Relayer 服务，实现事件监听、证明生成、交易提交的完整流程。

### 任务清单

#### 6.1 事件监听模块 (Day 43-45)
- [ ] 实现 Solana 事件监听（WebSocket）
- [ ] 实现 EVM 事件监听（WebSocket）
- [ ] 实现事件解析和存储
- [ ] 编写测试

**验收标准**：
- 可以监听到锁定/销毁事件
- 事件数据正确解析

#### 6.2 证明生成模块 (Day 46-48)
- [ ] 实现 RPC 数据获取
- [ ] 实现 SP1 证明生成调用
- [ ] 实现证明缓存
- [ ] 编写测试

**验收标准**：
- 可以为真实订单生成证明
- 证明可以被验证

#### 6.3 交易提交模块 (Day 49-51)
- [ ] 实现 Solana 交易构建和提交
- [ ] 实现 EVM 交易构建和提交
- [ ] 实现 Nonce 管理
- [ ] 实现重试机制
- [ ] 编写测试

**验收标准**：
- 可以成功提交交易到链上
- 交易确认后更新订单状态

#### 6.4 超时监控模块 (Day 52-53)
- [ ] 实现 pending 订单扫描
- [ ] 实现超时检测
- [ ] 实现自动触发退款（可选）
- [ ] 编写测试

**验收标准**：
- 可以检测到超时订单
- 可以发送通知或自动退款

#### 6.5 费用管理模块 (Day 54-55)
- [ ] 实现 gas price 估算
- [ ] 实现 relayer fee 领取
- [ ] 实现收益统计
- [ ] 编写测试

**验收标准**：
- 可以动态调整 gas price
- 可以领取 relayer 奖励

---

## Phase 7: 端到端集成测试 (Week 11-12)

### 目标
在本地测试环境中进行完整的跨链测试。

### 任务清单

#### 7.1 测试环境搭建 (Day 56-57)
- [ ] 启动 solana-test-validator
- [ ] 启动 Hardhat Network
- [ ] 部署所有合约
- [ ] 配置 Relayer 连接测试链

**验收标准**：
- 测试环境稳定运行
- Relayer 可以连接到测试链

#### 7.2 Solana → EVM 跨链测试 (Day 58-60)
- [ ] 测试正常流程：锁定 → 生成证明 → 铸造
- [ ] 测试超时流程：锁定 → 等待超时 → 退款
- [ ] 测试异常场景：无效证明、重放攻击等
- [ ] 性能测试

**验收标准**：
- 正常流程成功率 100%
- 超时退款正常工作
- 所有攻击被正确防御

#### 7.3 EVM → Solana 跨链测试 (Day 61-63)
- [ ] 测试正常流程
- [ ] 测试超时流程
- [ ] 测试异常场景
- [ ] 性能测试

**验收标准**：
- 正常流程成功率 100%
- 超时退款正常工作

#### 7.4 双向往返测试 (Day 64-66)
- [ ] 测试代币从 Solana → EVM → Solana
- [ ] 测试代币从 EVM → Solana → EVM
- [ ] 验证总供应量守恒
- [ ] 并发测试

**验收标准**：
- 往返测试成功
- 总供应量始终守恒
- 无资金损失

#### 7.5 压力测试 (Day 67-68)
- [ ] 测试高并发跨链
- [ ] 测试 Relayer 故障恢复
- [ ] 测试多个 Relayer 竞争
- [ ] 性能优化

**验收标准**：
- 系统在高负载下稳定
- Relayer 故障可以恢复

#### 7.6 安全测试 (Day 69-70)
- [ ] 重放攻击测试
- [ ] 双花攻击测试
- [ ] DOS 攻击测试
- [ ] 恶意 Relayer 测试

**验收标准**：
- 所有已知攻击被防御

---

## Phase 8: 测试网部署 (Week 13-14)

### 目标
部署到 Solana Devnet 和 Arbitrum Sepolia 测试网。

### 任务清单

#### 8.1 Solana Devnet 部署 (Day 71-73)
- [ ] 部署 Bridge Program
- [ ] 部署 SP1 Verifier
- [ ] 部署轻客户端
- [ ] 注册测试代币对

**验收标准**：
- 所有合约成功部署
- 可以通过浏览器查看

#### 8.2 Arbitrum Sepolia 部署 (Day 74-76)
- [ ] 部署 Bridge Contract
- [ ] 部署 SP1 Verifier
- [ ] 部署轻客户端
- [ ] 注册测试代币对

**验收标准**：
- 所有合约成功部署
- 可以通过 Arbiscan 查看

#### 8.3 Relayer 部署 (Day 77-78)
- [ ] 配置 Relayer 连接测试网
- [ ] 部署到云服务器
- [ ] 配置监控和告警
- [ ] 测试运行

**验收标准**：
- Relayer 稳定运行
- 可以处理测试网交易

#### 8.4 公开测试 (Day 79-84)
- [ ] 编写用户文档
- [ ] 发布测试公告
- [ ] 收集用户反馈
- [ ] 修复 Bug

**验收标准**：
- 至少 10 个外部用户测试
- 无重大 Bug

---

## Phase 9: 安全审计与优化 (Week 15-17)

### 目标
进行安全审计，优化性能，准备主网部署。

### 任务清单

#### 9.1 代码审计 (Day 85-91)
- [ ] 内部代码审计
- [ ] 第三方安全审计
- [ ] 修复审计发现的问题
- [ ] 形式化验证（可选）

**验收标准**：
- 通过第三方审计
- 无高危漏洞

#### 9.2 性能优化 (Day 92-98)
- [ ] 优化 SP1 证明生成时间
- [ ] 优化合约 gas 消耗
- [ ] 实现批量证明
- [ ] 优化 Relayer 性能

**验收标准**：
- 证明生成时间 < 30 秒
- EVM gas < 300k
- 吞吐量 > 20 TPS

#### 9.3 文档完善 (Day 99-105)
- [ ] 编写技术文档
- [ ] 编写用户文档
- [ ] 编写 API 文档
- [ ] 编写运维文档

**验收标准**：
- 文档完整且清晰

---

## Phase 10: 主网部署 (Week 18-19)

### 目标
部署到 Solana Mainnet 和 Arbitrum Mainnet。

### 任务清单

#### 10.1 主网部署准备 (Day 106-108)
- [ ] 主网部署计划
- [ ] 初始流动性准备
- [ ] 应急预案
- [ ] Bug Bounty 计划

**验收标准**：
- 部署计划完善
- 应急预案就绪

#### 10.2 主网部署 (Day 109-112)
- [ ] 部署 Solana Mainnet 合约
- [ ] 部署 Arbitrum Mainnet 合约
- [ ] 部署主网 Relayer
- [ ] 初始化桥

**验收标准**：
- 所有合约成功部署
- 系统正常运行

#### 10.3 监控与维护 (Day 113-119)
- [ ] 配置监控系统
- [ ] 7x24 值班
- [ ] 处理用户问题
- [ ] 持续优化

**验收标准**：
- 监控系统完善
- 快速响应问题

---

## 每个阶段的验收检查清单

### 代码质量
- [ ] 代码遵循最佳实践
- [ ] 有充分的注释
- [ ] 通过 Linter 检查
- [ ] 单元测试覆盖率 > 80%

### 功能完整性
- [ ] 所有功能按设计实现
- [ ] 边界情况处理正确
- [ ] 错误处理完善

### 安全性
- [ ] 无已知漏洞
- [ ] 输入验证完善
- [ ] 权限控制正确

### 性能
- [ ] 满足性能指标
- [ ] 无明显性能瓶颈

### 文档
- [ ] 代码有清晰注释
- [ ] 有使用文档
- [ ] 有测试文档

---

## 关键里程碑

| 里程碑 | 时间 | 交付物 |
|--------|------|--------|
| **M1: Solana 核心完成** | Week 2 | Solana Program + 测试 |
| **M2: EVM 核心完成** | Week 4 | EVM Contract + 测试 |
| **M3: ZK 证明系统完成** | Week 6 | SP1 Program + 测试 |
| **M4: 轻客户端完成** | Week 7 | 轻客户端 + 测试 |
| **M5: 智能合约集成完成** | Week 8 | 完整合约 + ZK 验证 |
| **M6: Relayer 完成** | Week 10 | Relayer 服务 + 测试 |
| **M7: 集成测试完成** | Week 12 | 端到端测试报告 |
| **M8: 测试网上线** | Week 14 | 测试网部署 |
| **M9: 审计完成** | Week 17 | 审计报告 |
| **M10: 主网上线** | Week 19 | 主网部署 |

---

## 风险管理

### 技术风险

| 风险 | 缓解措施 |
|------|---------|
| SP1 性能不达标 | 提前进行性能测试，准备降级方案 |
| 轻客户端复杂度高 | 阶段化实现，先用简化版本 |
| 跨链测试困难 | 搭建完善的本地测试环境 |

### 进度风险

| 风险 | 缓解措施 |
|------|---------|
| 开发延期 | 预留 buffer 时间，优先保证核心功能 |
| 审计发现重大问题 | 提前进行内部审计，留足修复时间 |
| 测试网问题多 | 充分的本地测试，提前暴露问题 |

---

## 下一步行动

现在开始 **Phase 1: Solana 单链核心功能** 的开发：

1. **Day 1**: 创建 Anchor 项目，定义数据结构
2. **Day 2-3**: 实现代币锁定功能
3. **Day 4-5**: 实现代币解锁功能
4. **Day 6-7**: 实现超时回滚功能
5. **Day 8-10**: 集成测试和代币销毁/铸造功能

**准备好开始了吗？我将从 Day 1 开始创建 Solana Anchor 项目！**

---

**文档版本**: v1.0  
**最后更新**: 2025-11-01  
**预计完成时间**: 19 周（约 4.5 个月）
