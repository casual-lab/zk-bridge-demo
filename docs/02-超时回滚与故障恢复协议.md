# è¶…æ—¶å›æ»šä¸æ•…éšœæ¢å¤åè®®è®¾è®¡

## 1. é—®é¢˜åˆ†æ

### 1.1 å½“å‰æ¶æ„çš„ç¼ºé™·

åœ¨ `01-è·¨é“¾æ¡¥æŠ€æœ¯æ¶æ„è®¾è®¡.md` ä¸­çš„æ­£å¸¸æµç¨‹å­˜åœ¨ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š

```
Solana é”å®šä»£å¸ â†’ Relayer è·å–è¯æ˜ â†’ [Relayer å®•æœº] â†’ âŒ æºé“¾æ— æ„ŸçŸ¥
```

**æ ¸å¿ƒçŸ›ç›¾**ï¼š
- æºé“¾ï¼ˆSolanaï¼‰åªçŸ¥é“è‡ªå·±é”å®šäº†ä»£å¸
- æºé“¾**ä¸çŸ¥é“**ç›®æ ‡é“¾ï¼ˆEVMï¼‰æ˜¯å¦æˆåŠŸé“¸é€ 
- Relayer å®•æœºåï¼Œæºé“¾ç¼ºä¹è§¦å‘è¶…æ—¶å›æ»šçš„æœºåˆ¶

### 1.2 æ ¹æœ¬åŸå› 

è·¨é“¾æ˜¯**å¼‚æ­¥è¿‡ç¨‹**ï¼Œä¸¤æ¡é“¾ä¹‹é—´æ²¡æœ‰ç›´æ¥é€šä¿¡ï¼š
- Solana ä¸èƒ½ç›´æ¥æŸ¥è¯¢ EVM çš„çŠ¶æ€
- å¿…é¡»ä¾èµ–**æ—¶é—´ç»´åº¦**ä½œä¸ºæ•…éšœæ£€æµ‹æ‰‹æ®µ
- éœ€è¦æ˜ç¡®**è°æœ‰æƒè§¦å‘è¶…æ—¶å›æ»š**

---

## 2. è§£å†³æ–¹æ¡ˆè®¾è®¡

### 2.1 æ ¸å¿ƒæ€è·¯

é‡‡ç”¨ **"è¶…æ—¶å³å¤±è´¥"** åŸåˆ™ï¼š

1. **æºé“¾è®¾ç½®è®¢å•è¶…æ—¶æ—¶é—´**ï¼šé”å®šä»£å¸æ—¶è®°å½• `created_slot/created_block`
2. **ä»»ä½•äººéƒ½å¯ä»¥è§¦å‘è¶…æ—¶æ£€æŸ¥**ï¼šç”¨æˆ·ã€å…¶ä»– relayerã€ç›‘æ§æœºå™¨äºº
3. **è¶…æ—¶åè‡ªåŠ¨å…è®¸é€€æ¬¾**ï¼šæ— éœ€éªŒè¯ç›®æ ‡é“¾çŠ¶æ€ï¼Œæ—¶é—´åˆ°äº†å°±èƒ½é€€

**å…³é”®è®¾è®¡ç‚¹**ï¼š
- âœ… æºé“¾åªéœ€æ£€æŸ¥ï¼š`å½“å‰æ—¶é—´ - åˆ›å»ºæ—¶é—´ > è¶…æ—¶é˜ˆå€¼`
- âœ… ä¸ä¾èµ–ç›®æ ‡é“¾åé¦ˆï¼ˆé¿å…è·¨é“¾æŸ¥è¯¢çš„å¤æ‚æ€§ï¼‰
- âœ… ç‰ºç‰²ä¸€å®šæ—¶é—´æ¢å–å®‰å…¨æ€§ï¼ˆç”¨æˆ·éœ€ç­‰å¾…è¶…æ—¶æœŸï¼‰

### 2.2 çŠ¶æ€æœºè®¾è®¡

```
è®¢å•çŠ¶æ€è½¬æ¢å›¾:

   [ç”¨æˆ·å‘èµ·]
       â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Pending â”‚ â† åˆå§‹çŠ¶æ€: ä»£å¸å·²é”å®šï¼Œç­‰å¾… relayer å¤„ç†
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ â†“
       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                    â”‚ (æ—¶é—´è¶…æ—¶)
       â”‚ (Relayer æäº¤è¯æ˜)                 â”‚
       â†“                                    â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Completed â”‚                      â”‚ Refunded â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   (ä»£å¸å·²é“¸é€ åˆ°                       (ä»£å¸å·²é€€è¿˜
    ç›®æ ‡é“¾ï¼Œè®¢å•                        ç»™ç”¨æˆ·ï¼Œè®¢å•
    ä¸å¯é€†)                            ä¸å¯é€†)
```

**çŠ¶æ€è½¬æ¢è§„åˆ™**ï¼š
- `Pending â†’ Completed`: Relayer åœ¨è¶…æ—¶å‰æäº¤æœ‰æ•ˆ ZK è¯æ˜
- `Pending â†’ Refunded`: ä»»ä½•äººåœ¨è¶…æ—¶åè°ƒç”¨ `refund_timeout()`
- `Completed/Refunded`: ç»ˆæ€ï¼Œä¸å¯å†è½¬æ¢

**é˜²æ­¢ç«æ€æ¡ä»¶**ï¼š
- Relayer æäº¤è¯æ˜æ—¶ï¼Œå¿…é¡»æ£€æŸ¥çŠ¶æ€æ˜¯ `Pending`
- ç”¨æˆ·ç”³è¯·é€€æ¬¾æ—¶ï¼Œå¿…é¡»æ£€æŸ¥çŠ¶æ€æ˜¯ `Pending` ä¸”å·²è¶…æ—¶
- ä½¿ç”¨åŸå­æ€§æ“ä½œï¼ˆCASï¼‰é˜²æ­¢å¹¶å‘ä¿®æ”¹

---

## 3. è¯¦ç»†åè®®æµç¨‹

### 3.1 æ­£å¸¸æµç¨‹ï¼ˆå«è¶…æ—¶ä¿æŠ¤ï¼‰

```
æ—¶é—´è½´ï¼š0s â”€â”€â”€â”€â”€â”€ 30s â”€â”€â”€â”€â”€â”€ 60s â”€â”€â”€â”€â”€â”€ 90s â”€â”€â”€â”€â”€â”€ è¶…æ—¶é˜ˆå€¼(600s) â”€â”€â”€â”€â”€â”€â†’

ç”¨æˆ· (Solana)           Solana Program          Relayer              EVM Contract
    |                         |                      |                      |
    |--lock_tokens(100)------>|                      |                      |
  [T=0]                       |                      |                      |
    |                    [é”å®šä»£å¸]                  |                      |
    |                    [Order #1: Pending]         |                      |
    |                    [created_slot = 1000]       |                      |
    |                    [timeout = 1000 + 1200      |                      |
    |                     = 2200 slot]               |                      |
    |                         |                      |                      |
    |                         |--TokensLocked------->|                      |
  [T=10s]                     |                      |                      |
    |                         |                 [ç›‘å¬åˆ°äº‹ä»¶]                |
    |                         |                 [è·å– Solana çŠ¶æ€]          |
  [T=30s]                     |                      |                      |
    |                         |                 [SP1 ç”Ÿæˆè¯æ˜]              |
    |                         |                 [è€—æ—¶ 20-50s]               |
  [T=60s]                     |                      |                      |
    |                         |                      |--mintTokens(proof)-->|
    |                         |                      |                      |
    |                         |                      |                 [éªŒè¯ proof]
    |                         |                      |                 [æ£€æŸ¥çŠ¶æ€=Pending]
    |                         |                      |                 [é“¸é€ ä»£å¸]
    |                         |                      |                      |
    |                         |<---ç›®æ ‡é“¾æˆåŠŸäº‹ä»¶(é€šè¿‡ relayer æäº¤ proof hash)--|
    |                         |                      |                      |
    |                    [æ›´æ–° Order #1:             |                      |
    |                     status = Completed]        |                      |
    |                    [è®°å½• proof_hash]           |                      |
    |                         |                      |                      |
    |                         |                      |<--relayer fee--------|
    |                         |                      |                      |
    
âœ… è®¢å•åœ¨è¶…æ—¶å‰å®Œæˆï¼Œç”¨æˆ·åœ¨ EVM æ”¶åˆ°ä»£å¸
```

### 3.2 Relayer å®•æœºåœºæ™¯ï¼ˆç”¨æˆ·ä¸»åŠ¨é€€æ¬¾ï¼‰

```
æ—¶é—´è½´ï¼š0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¶…æ—¶é˜ˆå€¼(600s) â”€â”€â”€â”€â”€â†’

ç”¨æˆ· (Solana)           Solana Program          Relayer              EVM Contract
    |                         |                      |                      |
    |--lock_tokens(100)------>|                      |                      |
  [T=0]                       |                      |                      |
    |                    [Order #1: Pending]         |                      |
    |                    [created_slot = 1000]       |                      |
    |                         |                      |                      |
    |                         |--TokensLocked------->|                      |
    |                         |                      |                      |
    |                         |                 [ğŸ’€ Relayer å®•æœº]          |
  [T=10s]                     |                      X                      |
    |                         |                      |                      |
    |    ... ç”¨æˆ·ç­‰å¾… 10 åˆ†é’Ÿ (600s) ...              |                      |
    |                         |                      |                      |
  [T=600s]                    |                      |                      |
    |  (å½“å‰ slot = 2200)     |                      |                      |
    |                         |                      |                      |
    |--refund_timeout(#1)---->|                      |                      |
    |                         |                      |                      |
    |                    [æ£€æŸ¥æ¡ä»¶:]                  |                      |
    |                    [1. status == Pending âœ…]   |                      |
    |                    [2. current_slot(2200)      |                      |
    |                        >= created_slot(1000)   |                      |
    |                           + timeout(1200) âœ…]  |                      |
    |                         |                      |                      |
    |                    [è§£é”ä»£å¸åˆ°ç”¨æˆ·è´¦æˆ·]         |                      |
    |                    [status = Refunded]         |                      |
    |                         |                      |                      |
    |<-----100 SPL é€€æ¬¾-------|                      |                      |
    |                         |                      |                      |

âœ… ç”¨æˆ·æˆåŠŸå–å›èµ„é‡‘ï¼Œè®¢å•æ ‡è®°ä¸º Refunded

åç»­å¦‚æœ Relayer æ¢å¤:
  [T=700s]                    |                      |                      |
    |                         |                 [æ¢å¤è¿è¡Œ]                  |
    |                         |                 [å°è¯•æäº¤è¯æ˜]              |
    |                         |                      |                      |
    |                         |                      |--mintTokens(proof)-->|
    |                         |                      |                      |
    |                         |                      |                 [éªŒè¯ proof]
    |                         |                      |                 [æ£€æŸ¥æºé“¾çŠ¶æ€]
    |                         |                      |                      |
    |                         |<---æŸ¥è¯¢ Order #1 çŠ¶æ€(é€šè¿‡é¢„è¨€æœºæˆ– ZK è¯æ˜)--|
    |                         |                      |                      |
    |                    [è¿”å›: status = Refunded]   |                      |
    |                         |                      |                      |
    |                         |                      |<--äº¤æ˜“å›æ»š-----------| âŒ
    |                         |                      |                [æ‹’ç»é“¸é€ :
    |                         |                      |                 è®¢å•å·²é€€æ¬¾]

âœ… é˜²æ­¢åŒèŠ±ï¼šç›®æ ‡é“¾æ‹’ç»ä¸ºå·²é€€æ¬¾è®¢å•é“¸é€ ä»£å¸
```

### 3.3 ç«äº‰åœºæ™¯ï¼šRelayer å’Œç”¨æˆ·åŒæ—¶æ“ä½œ

```
[Relayer æ­£åœ¨æäº¤è¯æ˜] vs [ç”¨æˆ·å°è¯•é€€æ¬¾]

åœºæ™¯ 1: Relayer å…ˆæäº¤ï¼ˆè®¢å•åœ¨è¶…æ—¶å‰å®Œæˆï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Relayer: mintTokens(proof) â†’ [T=590s] â†’ EVM éªŒè¯é€šè¿‡ â†’ é“¸é€ ä»£å¸
                                                      â†“
  Solana: æ¥æ”¶ proof_hash â†’ æ›´æ–° status = Completed [T=595s]
                                                      â†“
  User: refund_timeout() â†’ [T=601s] â†’ âŒ å¤±è´¥ (status != Pending)

âœ… Relayer è·èƒœï¼Œç”¨æˆ·æ— æ³•é€€æ¬¾


åœºæ™¯ 2: ç”¨æˆ·å…ˆé€€æ¬¾ï¼ˆè®¢å•è¶…æ—¶ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  User: refund_timeout() â†’ [T=601s] â†’ Solana æ£€æŸ¥è¶…æ—¶ â†’ status = Refunded
                                                      â†“
  Relayer: mintTokens(proof) â†’ [T=605s] â†’ EVM éªŒè¯é€šè¿‡
                                         â†“
                                    æ£€æŸ¥æºé“¾çŠ¶æ€ï¼ˆé€šè¿‡ ZK è¯æ˜ï¼‰
                                         â†“
                                    [Order status = Refunded]
                                         â†“
                                    âŒ æ‹’ç»é“¸é€ 

âœ… ç”¨æˆ·è·èƒœï¼ŒRelayer æ— æ³•å®Œæˆé“¸é€ 


åœºæ™¯ 3: å‡ ä¹åŒæ—¶ï¼ˆéœ€è¦åŸå­æ€§ä¿æŠ¤ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Relayer: mintTokens(proof)  â†’ [T=600.5s]
  User: refund_timeout()      â†’ [T=600.6s]

  å…³é”®ï¼šSolana Program ä½¿ç”¨**è´¦æˆ·é” + CAS æ“ä½œ**
  
  æ‰§è¡Œé¡ºåºï¼ˆç”± Solana è¿è¡Œæ—¶å†³å®šï¼‰:
  
  If Relayer å…ˆæ‰§è¡Œ:
    1. Relayer æ›´æ–° status = Completed
    2. User çš„äº¤æ˜“æ£€æŸ¥ status != Pending â†’ âŒ å¤±è´¥
  
  If User å…ˆæ‰§è¡Œ:
    1. User æ›´æ–° status = Refunded
    2. Relayer çš„äº¤æ˜“æ£€æŸ¥ status != Pending â†’ âŒ å¤±è´¥
    3. EVM ç«¯ç¨åä¹Ÿä¼šæ‹’ç»é“¸é€ 

âœ… åŸå­æ€§ä¿è¯ï¼šæœ‰ä¸”åªæœ‰ä¸€æ–¹æˆåŠŸ
```

---

## 4. æŠ€æœ¯å®ç°ç»†èŠ‚

### 4.1 Solana Program å®ç°

```rust
#[derive(Accounts)]
pub struct RefundTimeout<'info> {
    #[account(
        mut,
        seeds = [b"order", order.order_id.to_le_bytes().as_ref()],
        bump,
        constraint = order.status == OrderStatus::Pending @ BridgeError::OrderNotPending,
    )]
    pub order: Account<'info, TransferOrder>,
    
    #[account(mut)]
    pub user: Signer<'info>,
    
    pub bridge_config: Account<'info, BridgeConfig>,
    
    /// ä»£å¸è´¦æˆ·ï¼ˆé€€æ¬¾ç›®æ ‡ï¼‰
    #[account(mut)]
    pub user_token_account: Account<'info, TokenAccount>,
    
    /// æ¡¥åˆçº¦ä»£å¸è´¦æˆ·ï¼ˆé”å®šæºï¼‰
    #[account(mut)]
    pub bridge_token_account: Account<'info, TokenAccount>,
    
    pub token_program: Program<'info, Token>,
}

pub fn refund_timeout(ctx: Context<RefundTimeout>) -> Result<()> {
    let order = &mut ctx.accounts.order;
    let clock = Clock::get()?;
    let current_slot = clock.slot;
    
    // 1. æ£€æŸ¥æ˜¯å¦è¶…æ—¶
    require!(
        current_slot >= order.created_slot + ctx.accounts.bridge_config.timeout_slots,
        BridgeError::OrderNotTimedOut
    );
    
    // 2. æ£€æŸ¥è®¢å•çŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤é€€æ¬¾ï¼‰
    require!(
        order.status == OrderStatus::Pending,
        BridgeError::OrderNotPending
    );
    
    // 3. æ£€æŸ¥è°ƒç”¨è€…æƒé™ï¼ˆåªæœ‰åŸå§‹ç”¨æˆ·å¯ä»¥é€€æ¬¾ï¼‰
    require!(
        order.user == ctx.accounts.user.key(),
        BridgeError::UnauthorizedUser
    );
    
    // 4. è§£é”ä»£å¸ï¼ˆåŸå­æ“ä½œï¼‰
    token::transfer(
        CpiContext::new(
            ctx.accounts.token_program.to_account_info(),
            Transfer {
                from: ctx.accounts.bridge_token_account.to_account_info(),
                to: ctx.accounts.user_token_account.to_account_info(),
                authority: ctx.accounts.bridge_config.to_account_info(),
            },
        ),
        order.amount,
    )?;
    
    // 5. æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆé˜²æ­¢åç»­æ“ä½œï¼‰
    order.status = OrderStatus::Refunded;
    order.refunded_slot = Some(current_slot);
    
    emit!(OrderRefunded {
        order_id: order.order_id,
        user: order.user,
        amount: order.amount,
        refunded_slot: current_slot,
    });
    
    Ok(())
}
```

### 4.2 EVM Contract å®ç°

```solidity
// EVM ç«¯éœ€è¦éªŒè¯æºé“¾è®¢å•æœªè¢«é€€æ¬¾
function mintTokens(
    uint256 orderId,
    bytes calldata zkProof
) external nonReentrant {
    TransferOrder storage order = orders[orderId];
    
    // 1. åŸºç¡€æ£€æŸ¥
    require(order.user != address(0), "Order not found");
    require(order.status == OrderStatus.Pending, "Order not pending");
    
    // 2. éªŒè¯ ZK è¯æ˜ï¼ˆåŒ…å«æºé“¾è®¢å•çŠ¶æ€ï¼‰
    CrossChainProof memory proof = sp1Verifier.verify(zkProof);
    
    require(proof.orderId == orderId, "Order ID mismatch");
    require(proof.sourceChainStatus == SourceStatus.Locked, "Invalid source status");
    require(proof.isValid, "Invalid proof");
    
    // 3. æ£€æŸ¥æ—¶é—´çª—å£ï¼ˆé¢å¤–å®‰å…¨æ£€æŸ¥ï¼‰
    // ç¡®ä¿è¯æ˜æ˜¯åœ¨åˆç†æ—¶é—´å†…ç”Ÿæˆçš„
    require(
        block.number <= order.createdBlock + config.timeoutBlocks,
        "Proof submitted after timeout"
    );
    
    // 4. é“¸é€ ä»£å¸
    IERC20Mintable(order.tokenAddress).mint(order.recipient, order.amount);
    
    // 5. æ›´æ–°çŠ¶æ€
    order.status = OrderStatus.Completed;
    order.completedBlock = block.number;
    order.proofHash = keccak256(zkProof);
    
    // 6. æ”¯ä»˜ relayer è´¹ç”¨
    if (order.relayerFee > 0) {
        IERC20(order.tokenAddress).transfer(msg.sender, order.relayerFee);
    }
    
    emit TokensMinted(orderId, order.recipient, order.amount, msg.sender);
}

// è¶…æ—¶é€€æ¬¾ï¼ˆEVM â†’ Solana æ–¹å‘ï¼‰
function refundTimeout(uint256 orderId) external {
    TransferOrder storage order = orders[orderId];
    
    require(order.status == OrderStatus.Pending, "Order not pending");
    require(order.user == msg.sender, "Not order owner");
    require(
        block.number >= order.createdBlock + config.timeoutBlocks,
        "Not timed out yet"
    );
    
    // è§£é”/é”€æ¯ä»£å¸
    if (order.isNativeEVM) {
        // è§£é”åŸç”Ÿ EVM ä»£å¸
        IERC20(order.tokenAddress).transfer(order.user, order.amount);
    } else {
        // é”€æ¯å¤–æ¥ä»£å¸ï¼ˆä½†è¿™ä¼šå¯¼è‡´ä¸å¯¹ç§°ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
        // å®é™…ä¸Šåº”è¯¥é€šçŸ¥æºé“¾è§£é”ï¼Œè¿™é‡Œæ ‡è®°ä¸ºå¾…å¤„ç†
        revert("Cross-chain refund not supported yet");
    }
    
    order.status = OrderStatus.Refunded;
    
    emit OrderRefunded(orderId, order.user, order.amount);
}
```

---

## 5. ZK è¯æ˜ä¸­çš„çŠ¶æ€éªŒè¯

### 5.1 SP1 Program éœ€è¦éªŒè¯çš„å†…å®¹

```rust
// SP1 zkVM Program
fn verify_solana_order(order_id: u64, solana_state: SolanaState) -> CrossChainProof {
    // 1. éªŒè¯è®¢å•è´¦æˆ·å­˜åœ¨
    let order_account = solana_state.get_account(order_pda_address);
    require!(order_account.is_some(), "Order not found");
    
    // 2. è§£æè®¢å•æ•°æ®
    let order: TransferOrder = borsh::deserialize(order_account.data)?;
    
    // 3. éªŒè¯è®¢å•çŠ¶æ€
    require!(order.order_id == order_id, "Order ID mismatch");
    require!(order.status == OrderStatus::Pending, "Order not pending"); // ğŸ”‘ å…³é”®æ£€æŸ¥
    
    // 4. éªŒè¯ä»£å¸å·²é”å®š
    let bridge_token_account = solana_state.get_token_account(bridge_vault);
    require!(bridge_token_account.amount >= order.amount, "Insufficient locked");
    
    // 5. éªŒè¯ Merkle Proofï¼ˆè´¦æˆ·çŠ¶æ€å±äºæŸä¸ª slot çš„çŠ¶æ€æ ‘ï¼‰
    verify_merkle_proof(
        order_account.hash(),
        solana_state.state_root,
        order_account.merkle_proof,
    )?;
    
    // 6. è¾“å‡ºè¯æ˜
    CrossChainProof {
        order_id,
        source_chain_status: SourceStatus::Locked, // æ˜ç¡®æ ‡è®°æºé“¾çŠ¶æ€
        amount: order.amount,
        recipient: order.recipient,
        is_valid: true,
        proof_timestamp: solana_state.slot,
    }
}
```

### 5.2 ç›®æ ‡é“¾éªŒè¯é€»è¾‘

EVM åˆçº¦åœ¨è°ƒç”¨ `sp1Verifier.verify()` æ—¶ä¼šæ£€æŸ¥ï¼š

1. **è¯æ˜æœ‰æ•ˆæ€§**ï¼šZK è¯æ˜åœ¨æ•°å­¦ä¸Šæ­£ç¡®
2. **æºé“¾çŠ¶æ€**ï¼šè®¢å•çŠ¶æ€ä¸º `Pending`ï¼ˆæœªé€€æ¬¾ï¼‰
3. **æ—¶é—´çª—å£**ï¼šè¯æ˜ç”Ÿæˆæ—¶é—´åœ¨è¶…æ—¶å‰
4. **è®¢å•åŒ¹é…**ï¼šorder_idã€é‡‘é¢ã€æ¥æ”¶è€…ä¸€è‡´

**é˜²å¾¡ç­–ç•¥**ï¼š
- å¦‚æœ Relayer åœ¨è®¢å•é€€æ¬¾åæ‰æäº¤è¯æ˜ï¼ŒZK è¯æ˜ä¼šæ˜¾ç¤º `status = Refunded`
- EVM åˆçº¦æ‹’ç»ä¸ºé `Pending` çŠ¶æ€çš„è®¢å•é“¸é€ ä»£å¸

---

## 6. ç›‘æ§ä¸è‡ªåŠ¨åŒ–

### 6.1 è¶…æ—¶ç›‘æ§æœºå™¨äºº

é™¤äº†ç”¨æˆ·æ‰‹åŠ¨é€€æ¬¾ï¼Œå¯ä»¥éƒ¨ç½²ç›‘æ§æœºå™¨äººè‡ªåŠ¨å¸®åŠ©ç”¨æˆ·ï¼š

```rust
// ç›‘æ§æœºå™¨äººé€»è¾‘
async fn monitor_pending_orders() {
    loop {
        // 1. æ‰«ææ‰€æœ‰ Pending è®¢å•
        let pending_orders = fetch_pending_orders().await;
        
        for order in pending_orders {
            let current_slot = get_current_slot().await;
            
            // 2. æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            if current_slot >= order.created_slot + TIMEOUT_SLOTS {
                // 3. ä»£æ›¿ç”¨æˆ·å‘èµ·é€€æ¬¾äº¤æ˜“ï¼ˆéœ€ç”¨æˆ·æå‰æˆæƒï¼‰
                // æˆ–è€…å‘é€é€šçŸ¥ç»™ç”¨æˆ·
                notify_user_for_refund(order.user, order.order_id).await;
                
                // å¦‚æœç”¨æˆ·è®¾ç½®äº†è‡ªåŠ¨é€€æ¬¾æˆæƒ
                if user_has_auto_refund_enabled(order.user) {
                    submit_refund_tx(order.order_id).await;
                }
            }
        }
        
        sleep(Duration::from_secs(60)).await;
    }
}
```

### 6.2 Relayer å¥åº·æ£€æŸ¥

```rust
// Relayer æœåŠ¡å†…éƒ¨ç›‘æ§
async fn health_check() {
    loop {
        // 1. æ£€æŸ¥å¾…å¤„ç†è®¢å•é˜Ÿåˆ—
        let pending = get_pending_orders_in_queue().await;
        
        for order in pending {
            let elapsed = now() - order.created_time;
            
            // 2. å¦‚æœå¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå‘Šè­¦
            if elapsed > PROOF_GENERATION_MAX_TIME {
                alert("Proof generation timeout", order.order_id);
                
                // 3. å°è¯•é‡æ–°ç”Ÿæˆè¯æ˜
                retry_proof_generation(order.order_id).await;
            }
        }
        
        sleep(Duration::from_secs(30)).await;
    }
}
```

---

## 7. æ”¹è¿›å»ºè®®

### 7.1 åŒå‘ç¡®è®¤æœºåˆ¶ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

ä¸ºäº†æ›´å¿«å‘ç° Relayer æ•…éšœï¼Œå¯ä»¥å¼•å…¥**å¿ƒè·³æœºåˆ¶**ï¼š

```
1. Relayer è®¤é¢†è®¢å•æ—¶ï¼Œåœ¨æºé“¾æäº¤ "claim" äº¤æ˜“
2. æºé“¾è®°å½• relayer åœ°å€å’Œè®¤é¢†æ—¶é—´
3. å¦‚æœ relayer åœ¨çŸ­æ—¶é—´å†…ï¼ˆå¦‚ 2 åˆ†é’Ÿï¼‰æœªæäº¤è¯æ˜ï¼Œå…è®¸å…¶ä»– relayer æ¥æ‰‹
4. æœ€ç»ˆè¶…æ—¶æ—¶é—´ä»ä¸º 10 åˆ†é’Ÿï¼Œä½œä¸ºæœ€åä¿éšœ
```

**ä¼˜ç‚¹**ï¼šåŠ å¿«æ•…éšœå‘ç°  
**ç¼ºç‚¹**ï¼šå¢åŠ é“¾ä¸Šäº¤äº’æ¬¡æ•°å’Œå¤æ‚åº¦

### 7.2 åˆ†æ®µè¶…æ—¶

```
â”œâ”€â”€ çŸ­è¶…æ—¶ï¼ˆ2 åˆ†é’Ÿï¼‰ï¼šå…è®¸å…¶ä»– relayer ç«äº‰
â””â”€â”€ é•¿è¶…æ—¶ï¼ˆ10 åˆ†é’Ÿï¼‰ï¼šå…è®¸ç”¨æˆ·é€€æ¬¾
```

### 7.3 éƒ¨åˆ†é€€æ¬¾æœºåˆ¶ï¼ˆé«˜çº§ï¼‰

å¯¹äºå¤§é¢è®¢å•ï¼Œå¯ä»¥è®¾è®¡ï¼š
- ç¬¬ä¸€é˜¶æ®µè¶…æ—¶ï¼šé€€æ¬¾ 50%
- ç¬¬äºŒé˜¶æ®µè¶…æ—¶ï¼šé€€æ¬¾å‰©ä½™ 50%
- Relayer åœ¨ä»»æ„é˜¶æ®µå®Œæˆå¯è·å¾—å‰©ä½™é‡‘é¢

---

## 8. æ€»ç»“

### 8.1 æ ¸å¿ƒåŸåˆ™

| åŸåˆ™ | å®ç° |
|------|------|
| **è¶…æ—¶å³å¤±è´¥** | æºé“¾åªéœ€æ£€æŸ¥æ—¶é—´ï¼Œæ— éœ€æŸ¥è¯¢ç›®æ ‡é“¾ |
| **çŠ¶æ€ä¸å¯é€†** | Completed/Refunded ç»ˆæ€ï¼Œé˜²æ­¢åŒèŠ± |
| **åŸå­æ€§ä¿æŠ¤** | ä½¿ç”¨è´¦æˆ·é”ç¡®ä¿çŠ¶æ€è½¬æ¢äº’æ–¥ |
| **ä»»ä½•äººå¯è§¦å‘** | ç”¨æˆ·ã€ç›‘æ§æœºå™¨äººã€å¤‡ç”¨ relayer éƒ½èƒ½é€€æ¬¾ |
| **ZK è¯æ˜éªŒè¯çŠ¶æ€** | ç›®æ ‡é“¾éªŒè¯æºé“¾è®¢å•æœªé€€æ¬¾ |

### 8.2 å®‰å…¨ä¿è¯

1. âœ… **é˜²æ­¢èµ„é‡‘é”å®š**ï¼šç”¨æˆ·å¯åœ¨è¶…æ—¶åå–å›èµ„é‡‘
2. âœ… **é˜²æ­¢åŒèŠ±**ï¼šçŠ¶æ€æœºä¿è¯æœ‰ä¸”åªæœ‰ä¸€æ–¹æˆåŠŸ
3. âœ… **é˜²æ­¢é‡æ”¾**ï¼šè®¢å•çŠ¶æ€ä¸€æ¬¡æ€§è½¬æ¢
4. âœ… **é˜²æ­¢æ¶æ„ Relayer**ï¼šè¯æ˜å¿…é¡»åŒ…å«è®¢å•çŠ¶æ€éªŒè¯

### 8.3 ç”¨æˆ·ä½“éªŒ

- **æ­£å¸¸æƒ…å†µ**ï¼š1-3 åˆ†é’Ÿå®Œæˆè·¨é“¾
- **Relayer å®•æœº**ï¼š10 åˆ†é’Ÿåå¯é€€æ¬¾ï¼ˆå¯é€šè¿‡ç›‘æ§ç¼©çŸ­ï¼‰
- **Gas æˆæœ¬**ï¼šç”¨æˆ·åªéœ€æ”¯ä»˜é€€æ¬¾äº¤æ˜“ gas

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-31  
**ç›¸å…³æ–‡æ¡£**: `01-è·¨é“¾æ¡¥æŠ€æœ¯æ¶æ„è®¾è®¡.md`
