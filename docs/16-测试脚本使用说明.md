# 测试脚本使用说明

## 概述

由于 Phase 1.4 和旧版测试套件使用了相同的 PDA 地址,在同一个测试环境中运行会导致冲突。我们将测试分为两个独立的命令:

## 测试命令

### 1. Phase 1.4 测试 (推荐)

```bash
# 使用 anchor test (默认)
anchor test

# 或使用 yarn 命令
yarn test:phase14
```

**测试文件**: `tests/solana-evm-bridge-phase14.ts`

**测试内容**:
- ✅ Initialize bridge with relayer fee config
- ✅ Create SPL Token and accounts  
- ✅ Register token pair
- ✅ Initialize vault
- ✅ Lock tokens
- ✅ Unlock tokens with relayer fee
- ✅ Cannot unlock same order twice
- ✅ Minimum relayer fee applies to small orders
- ✅ Rejects invalid proof (all zeros)

**特点**:
- 完整的 Phase 1.4 功能测试
- 包含 relayer 费用机制
- 移除了超时退款机制
- 9 个测试全部通过

### 2. 旧版测试 (兼容性参考)

```bash
yarn test:legacy
```

**测试文件**: `tests/solana-evm-bridge.ts`

**说明**:
- 这是为了保持与旧代码的兼容性
- 已更新以适配 Phase 1.4 的改动
- 由于环境隔离问题,建议优先使用 Phase 1.4 测试

## 配置文件更改

### Anchor.toml

```toml
[scripts]
test = "yarn run ts-mocha -p ./tsconfig.json -t 1000000 \"tests/solana-evm-bridge-phase14.ts\""
```

现在 `anchor test` 默认运行 Phase 1.4 测试套件。

### package.json

```json
{
  "scripts": {
    "test:phase14": "anchor test",
    "test:legacy": "anchor localnet & sleep 5 && ts-mocha -p ./tsconfig.json -t 1000000 tests/solana-evm-bridge.ts; killall solana-test-validator"
  }
}
```

## 为什么需要分离测试?

1. **PDA 冲突**: 两个测试套件使用相同的 bridge config PDA
   - Bridge Config PDA: `Cm8qAcGNhST1vhW4MNcLnYE1Gg5XGKHYwtcXUPzJNhix`
   - 在同一个 localnet 实例中,PDA 只能初始化一次

2. **状态共享**: 测试之间会共享链上状态
   - 订单状态会在测试间传递
   - 导致 "Order not in pending status" 错误

3. **独立验证**: 分离测试确保每个套件在独立环境中运行
   - Phase 1.4 测试验证新功能
   - Legacy 测试确保向后兼容

## 推荐工作流程

### 日常开发
```bash
# 开发新功能时,运行 Phase 1.4 测试
anchor test
```

### 完整验证
```bash
# 1. 运行 Phase 1.4 测试
anchor test

# 2. (可选) 运行 legacy 测试检查兼容性
yarn test:legacy
```

### CI/CD 集成
```bash
# 在 CI 中只运行 Phase 1.4 测试
anchor test
```

## Phase 1.4 vs Legacy 对比

| 特性 | Phase 1.4 | Legacy |
|------|-----------|--------|
| 超时退款 | ❌ 已移除 | ❌ 已适配移除 |
| Relayer 费用 | ✅ 0.1% + 最小费用 | ✅ 已更新 |
| 最小费用 | ✅ 0.05 USDC | ✅ 已更新 |
| 订单状态 | Pending/Completed | Pending/Completed |
| 测试覆盖率 | 9 个测试 | 6 个核心测试 |
| 竞争机制 | ✅ 原子更新就绪 | ✅ 已更新 |

## 故障排除

### 问题: "Account already in use"
**原因**: Bridge 已在当前 localnet 中初始化
**解决**: 重启 localnet 或使用独立的测试命令

### 问题: "Order not in pending status"  
**原因**: 订单已被其他测试解锁
**解决**: 使用分离的测试命令,确保环境独立

### 问题: "ANCHOR_PROVIDER_URL is not defined"
**原因**: 直接运行 ts-mocha 而没有启动 localnet
**解决**: 使用 `anchor test` 或确保 localnet 正在运行

## 未来改进

考虑为不同的测试套件使用不同的 chain ID 或 admin 地址来生成不同的 PDA,以便在同一环境中运行所有测试。但目前的分离方案已经足够且更加清晰。
