# åŸºäº SP1 zkVM çš„åŒå‘è·¨é“¾æ¡¥ - ç¬¬äºŒç‰ˆæ•´ä½“è®¾è®¡

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 æ ¸å¿ƒç‰¹æ€§

åŸºäº SP1 zkVM çš„ Solana-EVM åŒå‘è·¨é“¾æ¡¥ï¼Œå®ç° SPL Token ä¸ ERC-20 Token çš„å®‰å…¨åŒå‘è½¬ç§»ï¼Œå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒç‰¹æ€§ï¼š

- **åŒå‘å¯¹ç§°**ï¼šSolana â†” Arbitrum/EVM é“¾å®Œå…¨å¯¹ç§°çš„è·¨é“¾è½¬ç§»
- **ZK ä¿¡ä»»æœºåˆ¶**ï¼šä½¿ç”¨ SP1 zkVM ç”Ÿæˆè·¨é“¾çŠ¶æ€è¯æ˜ï¼Œæ— éœ€ä¿¡ä»»ç¬¬ä¸‰æ–¹
- **åŸå­æ€§ä¿è¯**ï¼šé€šè¿‡çŠ¶æ€æœºç¡®ä¿æœ‰ä¸”åªæœ‰ä¸€æ–¹æˆåŠŸ
- **è¶…æ—¶å›æ»š**ï¼šRelayer æ•…éšœæ—¶ç”¨æˆ·å¯è‡ªä¸»é€€æ¬¾ï¼ˆSolana: slot è®¡æ•°ï¼ŒEVM: block è®¡æ•°ï¼‰
- **Relayer æ¿€åŠ±**ï¼šåŸºäºæ‰‹ç»­è´¹çš„ç»æµæ¨¡å‹ï¼Œæ”¯æŒå¤šä¸ª relayer ç«äº‰

### 1.2 ä¿¡ä»»æ¨¡å‹

```
Layer 1: åŒºå—é“¾å…±è¯† (å¿…é¡»ä¿¡ä»»)
â”œâ”€â”€ Solana PoS å…±è¯†ä¿è¯çŠ¶æ€çœŸå®æ€§
â””â”€â”€ EVM å…±è¯†ä¿è¯çŠ¶æ€çœŸå®æ€§

Layer 2: ZK æ•°å­¦è¯æ˜ (å¯†ç å­¦ä¿¡ä»»)
â”œâ”€â”€ SP1 zkVM å®ç°æ­£ç¡®æ€§
â”œâ”€â”€ STARK/Groth16 å¯†ç å­¦å®‰å…¨
â””â”€â”€ Trusted Setup æœªè¢«ç ´å

Layer 3: çŠ¶æ€æ ¹éªŒè¯ (è½»å®¢æˆ·ç«¯)
â”œâ”€â”€ é“¾ä¸Šè½»å®¢æˆ·ç«¯éªŒè¯çŠ¶æ€æ ¹
â””â”€â”€ é˜²æ­¢ Relayer ä¼ªé€ çŠ¶æ€æ ¹

Layer 4: æ™ºèƒ½åˆçº¦é€»è¾‘ (å®¡è®¡)
â””â”€â”€ å¼€æºä»£ç å¯å®¡è®¡
```

---

## 2. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·å±‚                                    â”‚
â”‚              (å‘èµ·è·¨é“¾è½¬è´¦ã€é¢†å–ä»£å¸ã€å›æ»šè¶…æ—¶è®¢å•)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ™ºèƒ½åˆçº¦å±‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Solana Program  â”‚              â”‚  EVM Contract    â”‚         â”‚
â”‚  â”‚  - Lock/Burn     â”‚              â”‚  - Lock/Burn     â”‚         â”‚
â”‚  â”‚  - Mint/Unlock   â”‚              â”‚  - Mint/Unlock   â”‚         â”‚
â”‚  â”‚  - Verify ZK     â”‚              â”‚  - Verify ZK     â”‚         â”‚
â”‚  â”‚  - Timeout Logic â”‚              â”‚  - Timeout Logic â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Relayer æœåŠ¡å±‚                               â”‚
â”‚  - ç›‘å¬æºé“¾é”å®š/é”€æ¯äº‹ä»¶                                           â”‚
â”‚  - è°ƒç”¨ SP1 zkVM ç”Ÿæˆè¯æ˜                                         â”‚
â”‚  - æäº¤è¯æ˜åˆ°ç›®æ ‡é“¾å®Œæˆé“¸é€                                         â”‚
â”‚  - ç›‘æ§è¶…æ—¶è®¢å•å¹¶è§¦å‘å›æ»š                                          â”‚
â”‚  - èµšå–æ‰‹ç»­è´¹æ”¶ç›Š                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SP1 zkVM å±‚                                 â”‚
â”‚  - éªŒè¯æºé“¾çŠ¶æ€ï¼ˆäº¤æ˜“ã€è´¦æˆ·ä½™é¢ã€äº‹ä»¶æ—¥å¿—ï¼‰                         â”‚
â”‚  - ç”Ÿæˆç®€æ´ ZK è¯æ˜ï¼ˆGroth16/PLONKï¼‰                              â”‚
â”‚  - ç›®æ ‡é“¾é«˜æ•ˆéªŒè¯ï¼ˆGas ä¼˜åŒ–ï¼‰                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®å±‚                                       â”‚
â”‚  - Solana RPC: è·å– slotã€è´¦æˆ·çŠ¶æ€ã€äº¤æ˜“è¯æ˜                       â”‚
â”‚  - EVM RPC: è·å– blockã€event logsã€storage proofs               â”‚
â”‚  - è½»å®¢æˆ·ç«¯: éªŒè¯çŠ¶æ€æ ¹å“ˆå¸Œ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 3.1 æ™ºèƒ½åˆçº¦å±‚

#### Solana Program ç»“æ„

```rust
#[program]
pub mod solana_evm_bridge {
    use super::*;

    // å…¨å±€é…ç½®
    #[account]
    pub struct BridgeConfig {
        pub admin: Pubkey,
        pub evm_chain_id: u64,
        pub timeout_slots: u64,           // è¶…æ—¶ slot æ•°
        pub relayer_fee_bps: u16,         // æ‰‹ç»­è´¹åŸºç‚¹ (1/10000)
        pub sp1_verifier: Pubkey,         // SP1 éªŒè¯å™¨ç¨‹åº
        pub paused: bool,
    }

    // ä»£å¸å¯¹é…ç½®
    #[account]
    pub struct TokenConfig {
        pub solana_mint: Pubkey,
        pub evm_token: [u8; 20],
        pub is_native_solana: bool,       // æ˜¯å¦åŸç”Ÿ Solana ä»£å¸
        pub total_locked: u64,
    }

    // è·¨é“¾è®¢å•
    #[account]
    pub struct TransferOrder {
        pub order_id: u64,
        pub user: Pubkey,
        pub source_chain: u8,             // 0: Solana, 1: EVM
        pub token_config: Pubkey,
        pub amount: u64,
        pub recipient: [u8; 20],          // EVM åœ°å€
        pub relayer_fee: u64,
        pub created_slot: u64,
        pub status: OrderStatus,          // Pending, Completed, Refunded
        pub proof_hash: [u8; 32],         // é˜²æ­¢é‡æ”¾
    }

    // æŒ‡ä»¤
    pub fn initialize_bridge(ctx: Context<InitializeBridge>) -> Result<()> { ... }
    pub fn register_token_pair(ctx: Context<RegisterTokenPair>) -> Result<()> { ... }
    pub fn lock_tokens(ctx: Context<LockTokens>) -> Result<()> { ... }
    pub fn burn_tokens(ctx: Context<BurnTokens>) -> Result<()> { ... }
    pub fn mint_tokens(ctx: Context<MintTokens>) -> Result<()> { ... }
    pub fn unlock_tokens(ctx: Context<UnlockTokens>) -> Result<()> { ... }
    pub fn refund_timeout(ctx: Context<RefundTimeout>) -> Result<()> { ... }
    pub fn claim_relayer_fee(ctx: Context<ClaimRelayerFee>) -> Result<()> { ... }
}
```

#### EVM Contract ç»“æ„

```solidity
contract SolanaEVMBridge {
    // å…¨å±€é…ç½®
    struct BridgeConfig {
        address admin;
        uint64 solanaChainId;
        uint256 timeoutBlocks;        // è¶…æ—¶ block æ•°
        uint16 relayerFeeBps;         // æ‰‹ç»­è´¹åŸºç‚¹
        address sp1Verifier;          // SP1 éªŒè¯å™¨åˆçº¦
        bool paused;
    }

    // ä»£å¸å¯¹é…ç½®
    struct TokenPair {
        address evmToken;
        bytes32 solanaMint;
        bool isNativeEVM;
        uint256 totalLocked;
    }

    // è·¨é“¾è®¢å•
    struct TransferOrder {
        uint256 orderId;
        address user;
        uint8 sourceChain;
        address tokenPair;
        uint256 amount;
        bytes32 recipient;            // Solana åœ°å€
        uint256 relayerFee;
        uint256 createdBlock;
        OrderStatus status;
        bytes32 proofHash;
    }

    // å‡½æ•°
    function initializeBridge() external { ... }
    function registerTokenPair() external { ... }
    function lockTokens(uint256 amount, bytes32 recipient) external { ... }
    function burnTokens(uint256 amount, bytes32 recipient) external { ... }
    function mintTokens(uint256 orderId, bytes calldata proof) external { ... }
    function unlockTokens(uint256 orderId, bytes calldata proof) external { ... }
    function refundTimeout(uint256 orderId) external { ... }
    function claimRelayerFee(uint256 orderId) external { ... }
}
```

### 3.2 SP1 zkVM è¯æ˜ç³»ç»Ÿ

#### è¯æ˜å†…å®¹ç»“æ„

```rust
// è·¨é“¾è¯æ˜è¾“å…¥ (ç§æœ‰)
pub struct CrossChainProofInput {
    // æºé“¾ä¿¡æ¯
    pub source_chain_id: u64,
    pub source_block_height: u64,    // Solana slot æˆ– EVM block
    pub source_state_root: [u8; 32],
    
    // è®¢å•æ•°æ®
    pub order_account_data: Vec<u8>, // å®Œæ•´è´¦æˆ·æ•°æ®
    pub merkle_proof: Vec<[u8; 32]>, // Merkle è¯æ˜è·¯å¾„
    pub merkle_path: Vec<bool>,      // Merkle è·¯å¾„æ–¹å‘
    
    // è¾…åŠ©æ•°æ®
    pub current_slot: u64,           // å½“å‰ slot (æ—¶é—´çª—å£éªŒè¯)
}

// è¯æ˜è¾“å‡º (å…¬å¼€)
pub struct CrossChainProofOutput {
    pub source_chain_id: u64,
    pub source_block_height: u64,
    pub source_state_root: [u8; 32],
    
    pub order_id: u64,
    pub token_address: [u8; 32],
    pub amount: u64,
    pub recipient: [u8; 32],
    pub order_status: u8,            // å¿…é¡»æ˜¯ Pending/Locked
    
    pub is_valid: bool,
    pub proof_nonce: u64,            // é˜²é‡æ”¾
}
```

#### Guest Program é€»è¾‘

```rust
#![no_main]
sp1_zkvm::entrypoint!(main);

pub fn main() {
    // 1. è¯»å–ç§æœ‰è¾“å…¥
    let input: CrossChainProofInput = sp1_zkvm::io::read();
    
    // 2. éªŒè¯ Merkle è¯æ˜
    let leaf_hash = hash_account(&input.order_account_data);
    let computed_root = compute_merkle_root(
        leaf_hash,
        &input.merkle_proof,
        &input.merkle_path,
    );
    
    // å…³é”®éªŒè¯ï¼šçŠ¶æ€æ ¹å¿…é¡»åŒ¹é…
    assert_eq!(
        computed_root,
        input.source_state_root,
        "Merkle proof verification failed"
    );
    
    // 3. è§£æè®¢å•æ•°æ®
    let order: TransferOrder = borsh::deserialize(&input.order_account_data)
        .expect("Failed to deserialize order");
    
    // 4. éªŒè¯è®¢å•çŠ¶æ€
    assert_eq!(
        order.status,
        OrderStatus::Pending,
        "Order not in pending state"
    );
    
    // 5. éªŒè¯æ—¶é—´çª—å£
    assert!(
        input.current_slot < order.created_slot + TIMEOUT_SLOTS,
        "Order has timed out"
    );
    
    // 6. éªŒè¯é‡‘é¢æœ‰æ•ˆæ€§
    assert!(order.amount > 0, "Invalid amount");
    
    // 7. è¾“å‡ºå…¬å¼€ç»“æœ
    let output = CrossChainProofOutput {
        source_chain_id: input.source_chain_id,
        source_block_height: input.source_block_height,
        source_state_root: input.source_state_root,
        
        order_id: order.order_id,
        token_address: order.token_mint.to_bytes(),
        amount: order.amount,
        recipient: order.recipient,
        order_status: order.status as u8,
        
        is_valid: true,
        proof_nonce: generate_nonce(),
    };
    
    sp1_zkvm::io::commit(&output);
}
```

### 3.3 Relayer æœåŠ¡æ¶æ„

```
Relayer Node:
â”œâ”€â”€ Event Monitor
â”‚   â”œâ”€â”€ Solana Event Listener (WebSocket)
â”‚   â””â”€â”€ EVM Event Listener (WebSocket/HTTP)
â”‚
â”œâ”€â”€ Proof Generator
â”‚   â”œâ”€â”€ SP1 zkVM Runtime
â”‚   â”œâ”€â”€ Proof Cache (Redis)
â”‚   â””â”€â”€ Proof Queue (RabbitMQ)
â”‚
â”œâ”€â”€ Transaction Submitter
â”‚   â”œâ”€â”€ Solana Transaction Builder
â”‚   â”œâ”€â”€ EVM Transaction Builder
â”‚   â””â”€â”€ Nonce Manager
â”‚
â”œâ”€â”€ Timeout Monitor
â”‚   â”œâ”€â”€ æ‰«æ pending orders
â”‚   â””â”€â”€ è§¦å‘è¶…æ—¶é€€æ¬¾
â”‚
â””â”€â”€ Fee Manager
    â”œâ”€â”€ è®¡ç®—æœ€ä¼˜ gas price
    â””â”€â”€ é¢†å– relayer å¥–åŠ±
```

#### å·¥ä½œæµç¨‹

```
1. ç›‘å¬æºé“¾é”å®š/é”€æ¯äº‹ä»¶
   â†“
2. æå–è®¢å•å‚æ•° (order_id, amount, recipient...)
   â†“
3. è·å–æºé“¾çŠ¶æ€æ•°æ® (block/slot, merkle proof, account state)
   â†“
4. è°ƒç”¨ SP1 zkVM ç”Ÿæˆè¯æ˜ (è€—æ—¶ ~10-60s)
   â†“
5. æäº¤è¯æ˜åˆ°ç›®æ ‡é“¾åˆçº¦
   â†“
6. ç­‰å¾…äº¤æ˜“ç¡®è®¤
   â†“
7. é¢†å– relayer fee
```

### 3.4 è½»å®¢æˆ·ç«¯è®¾è®¡

#### çŠ¶æ€æ ¹éªŒè¯

```solidity
contract SolanaLightClient {
    // å­˜å‚¨å·²éªŒè¯çš„çŠ¶æ€æ ¹
    mapping(uint64 => bytes32) public slotToStateRoot;
    mapping(bytes32 => bool) public verifiedStateRoots;
    
    // éªŒè¯å™¨é›†åˆ
    address[] public validators;
    mapping(address => bool) public isValidator;
    
    // æäº¤çŠ¶æ€æ ¹ (ç”± relayer æˆ–ç›‘æ§æœåŠ¡è°ƒç”¨)
    function submitStateRoot(
        uint64 slot,
        bytes32 stateRoot,
        bytes[] calldata validatorSignatures
    ) external {
        // éªŒè¯ 2/3 éªŒè¯è€…ç­¾å
        require(
            verifyValidatorSignatures(slot, stateRoot, validatorSignatures),
            "Invalid validator signatures"
        );
        
        slotToStateRoot[slot] = stateRoot;
        verifiedStateRoots[stateRoot] = true;
    }
    
    // éªŒè¯çŠ¶æ€æ ¹æ˜¯å¦æœ‰æ•ˆ
    function isValidStateRoot(uint64 slot, bytes32 stateRoot) external view returns (bool) {
        return slotToStateRoot[slot] == stateRoot && verifiedStateRoots[stateRoot];
    }
}
```

---

## 4. è·¨é“¾åè®®æµç¨‹

### 4.1 æ­£å¸¸æµç¨‹: Solana â†’ EVM

```
ç”¨æˆ· (Solana)           Solana Program         Relayer              EVM Contract           ç”¨æˆ· (EVM)
    |                         |                      |                      |                      |
    |--lock_tokens(100)------>|                      |                      |                      |
  [T=0]                       |                      |                      |                      |
    |                    [é”å®š 100 SPL]              |                      |                      |
    |                    [Order #1: Pending]         |                      |                      |
    |                    [created_slot = 1000]       |                      |                      |
    |                         |                      |                      |                      |
    |                         |--TokensLocked------->|                      |                      |
    |                         |                      |                      |                      |
    |                         |                 [ç›‘å¬åˆ°äº‹ä»¶]                |                      |
    |                         |                 [è·å– Solana çŠ¶æ€]          |                      |
    |                         |                      |                      |                      |
    |                         |                 [SP1 ç”Ÿæˆè¯æ˜]              |                      |
    |                         |                      |                      |                      |
    |                         |                      |--mintTokens(#1, proof)->                     |
    |                         |                      |                      |                      |
    |                         |                      |                 [éªŒè¯ ZK è¯æ˜]             |
    |                         |                      |                 [éªŒè¯çŠ¶æ€æ ¹]               |
    |                         |                      |                 [é“¸é€  100 ERC-20]          |
    |                         |                      |                      |                      |
    |                         |<---proof_hash---------|                      |                      |
    |                         |                      |                      |                      |
    |                    [æ›´æ–° Order #1:             |                      |                      |
    |                     status = Completed]        |                      |                      |
    |                         |                      |                      |                      |
    |                         |                      |<--relayer fee--------|                      |
    |                         |                      |                      |                      |
    |                         |                      |                      |------100 tokens------->|
    |                         |                      |                      |                      |
```

### 4.2 è¶…æ—¶å›æ»šæµç¨‹

```
ç”¨æˆ· (Solana)           Solana Program         Relayer              EVM Contract
    |                         |                      |                      |
    |--lock_tokens(100)------>|                      |                      |                      |
  [T=0]                       |                      |                      |
    |                    [Order #1: Pending]         |                      |                      |
    |                    [created_slot = 1000]       |                      |                      |
    |                         |                      |                      |
    |                         |--TokensLocked------->|                      |                      |
    |                         |                      |                      |
    |                         |                 [ğŸ’€ Relayer å®•æœº]          |                      |
    |                         |                      |                      |
    |          ... ç­‰å¾…è¶…æ—¶ (1200 slots) ...          |                      |
    |                         |                      |                      |
    |--refund_timeout(#1)---->|                      |                      |
    |                         |                      |                      |
    |                    [æ£€æŸ¥: current_slot         |                      |
    |                     > 1000 + 1200 âœ…]          |                      |
    |                    [æ£€æŸ¥: status = Pending âœ…]  |                      |
    |                    [è§£é” 100 SPL]              |                      |
    |                    [status = Refunded]         |                      |
    |                         |                      |                      |
    |<-----100 SPL é€€æ¬¾-------|                      |                      |
    |                         |                      |
```

### 4.3 åŒå‘å¯¹ç§°æ€§

| æ“ä½œ | Solana â†’ EVM | EVM â†’ Solana |
|------|--------------|--------------|
| åŸç”Ÿä»£å¸è·¨é“¾ | Lock SPL â†’ Mint ERC-20 | Lock ERC-20 â†’ Mint SPL |
| å¤–æ¥ä»£å¸è¿”å› | Burn ERC-20 â†’ Unlock SPL | Burn SPL â†’ Unlock ERC-20 |
| è¶…æ—¶åˆ¤æ–­ | current_slot - created_slot > timeout | block.number - createdBlock > timeout |
| è¯æ˜ç”Ÿæˆ | SP1 éªŒè¯ Solana state | SP1 éªŒè¯ EVM logs/storage |
| è¯æ˜éªŒè¯ | EVM åˆçº¦éªŒè¯ | Solana Program éªŒè¯ |

---

## 5. ç»æµæ¨¡å‹

### 5.1 æ‰‹ç»­è´¹ç»“æ„

```
ç”¨æˆ·æ”¯ä»˜æ€»è´¹ç”¨ = è·¨é“¾é‡‘é¢ Ã— relayerFeeBps / 10000 + å›ºå®šè´¹ç”¨

ç¤ºä¾‹:
- è·¨é“¾ 1000 USDC
- relayerFeeBps = 30 (0.3%)
- å›ºå®šè´¹ç”¨ = 0.5 USDC
- æ€»è´¹ç”¨ = 1000 Ã— 0.003 + 0.5 = 3.5 USDC
```

### 5.2 Relayer æ¿€åŠ±æœºåˆ¶

1. **åŸºç¡€å¥–åŠ±**: æ¯ç¬”è®¢å•çš„ relayer_fee
2. **Gas è¡¥å¿**: åŠ¨æ€è°ƒæ•´ fee è¦†ç›–é“¾ä¸Š gas æˆæœ¬
3. **ç«äº‰æ¨¡å¼**: å¤šä¸ª relayer ç«äº‰ï¼Œæœ€å¿«æäº¤è€…è·å¾—å¥–åŠ±
4. **è´¨æŠ¼è¦æ±‚**: Relayer éœ€è´¨æŠ¼ä¿è¯é‡‘ï¼Œæäº¤é”™è¯¯è¯æ˜å°†è¢«ç½šæ²¡

### 5.3 å®‰å…¨å‚¨å¤‡é‡‘

- åˆçº¦æŒæœ‰ 5% è·¨é“¾é‡‘é¢ä½œä¸ºå®‰å…¨å‚¨å¤‡
- ç”¨äºåº”å¯¹æç«¯æƒ…å†µ (å¦‚ ZK proof æ¼æ´)
- æ²»ç†æŠ•ç¥¨å¯è°ƒæ•´æ¯”ä¾‹

---

## 6. å®‰å…¨æœºåˆ¶

### 6.1 å¤šå±‚éªŒè¯

1. **ZK è¯æ˜éªŒè¯**: æ ¸å¿ƒä¿¡ä»»æ¥æºï¼ŒéªŒè¯æºé“¾çŠ¶æ€
2. **çŠ¶æ€æ ¹éªŒè¯**: è½»å®¢æˆ·ç«¯ç¡®ä¿çŠ¶æ€æ ¹æ¥è‡ªæºé“¾
3. **è®¢å•çŠ¶æ€æœº**: é˜²æ­¢é‡æ”¾æ”»å‡»ï¼Œç¡®ä¿åŸå­æ€§
4. **è¶…æ—¶ä¿æŠ¤**: é˜²æ­¢èµ„é‡‘æ°¸ä¹…é”å®š
5. **æš‚åœå¼€å…³**: ç´§æ€¥æƒ…å†µä¸‹å†»ç»“åˆçº¦

### 6.2 æ”»å‡»é˜²å¾¡

| æ”»å‡»ç±»å‹ | é˜²å¾¡æªæ–½ |
|---------|---------|
| é‡æ”¾æ”»å‡» | å”¯ä¸€ order_id + å·²å®Œæˆè®¢å•æ ‡è®° + proof_hash |
| åŒèŠ±æ”»å‡» | ZK è¯æ˜éªŒè¯ + é“¾ä¸ŠçŠ¶æ€æ£€æŸ¥ + çŠ¶æ€æœº |
| DOS æ”»å‡» | Relayer è´¹ç”¨é—¨æ§› + Rate limiting |
| æ¶æ„ Relayer | è¯æ˜éªŒè¯ + ç«äº‰æœºåˆ¶ + è´¨æŠ¼æƒ©ç½š |
| æ™ºèƒ½åˆçº¦æ¼æ´ | å®¡è®¡ + Bug Bounty + æ—¶é—´é”å‡çº§ |

### 6.3 æ•…éšœæ¢å¤

- **Relayer æ•…éšœ**: ç”¨æˆ·å¯åœ¨è¶…æ—¶åè‡ªè¡Œé€€æ¬¾
- **ZK è¯æ˜ç”Ÿæˆå¤±è´¥**: Relayer è‡ªåŠ¨é‡è¯•æˆ–å…¶ä»– relayer æ¥æ‰‹
- **ç›®æ ‡é“¾æ‹¥å µ**: åŠ¨æ€è°ƒæ•´ gas priceï¼Œç¡®ä¿äº¤æ˜“ä¸Šé“¾
- **æºé“¾é‡ç»„**: ç­‰å¾…è¶³å¤Ÿç¡®è®¤æ•° (Solana: 32 slots, EVM: 12 blocks)

---

## 7. æŠ€æœ¯é€‰å‹

### 7.1 å¼€å‘æ¡†æ¶

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç†ç”± |
|------|----------|------|
| Solana Program | Anchor Framework | ç±»å‹å®‰å…¨ã€è‡ªåŠ¨ç”Ÿæˆ IDLã€ç®€åŒ– PDA ç®¡ç† |
| EVM Contract | Solidity 0.8.x + Hardhat | æˆç†Ÿå·¥å…·é“¾ã€ä¸°å¯Œæµ‹è¯•æ¡†æ¶ |
| ZK è¯æ˜ç³»ç»Ÿ | SP1 zkVM (Succinct Labs) | é€šç”¨ zkVMã€æ”¯æŒ Rustã€Groth16/PLONK |
| Relayer åç«¯ | Rust + Tokio | é«˜æ€§èƒ½å¼‚æ­¥ã€ä¸ SP1 æ— ç¼é›†æˆ |
| æ•°æ®åº“ | PostgreSQL + Redis | æŒä¹…åŒ–è®¢å• + ç¼“å­˜è¯æ˜ |
| æ¶ˆæ¯é˜Ÿåˆ— | RabbitMQ | è§£è€¦äº‹ä»¶ç›‘å¬ä¸è¯æ˜ç”Ÿæˆ |
| è½»å®¢æˆ·ç«¯ | è‡ªå®šä¹‰å®ç° | éªŒè¯çŠ¶æ€æ ¹ã€æ”¯æŒ Solana éªŒè¯å™¨ç­¾å |

### 7.2 æµ‹è¯•ç¯å¢ƒ

| é“¾ | æœ¬åœ°æµ‹è¯•å·¥å…· | RPC |
|----|--------------|-----|
| Solana | `solana-test-validator` | http://localhost:8899 |
| EVM | Hardhat Network | http://localhost:8545 |
| Arbitrum æµ‹è¯•ç½‘ | Arbitrum Sepolia | å…¬å…± RPC |

### 7.3 SP1 zkVM é›†æˆ

```rust
// SP1 Prover (Relayer ç«¯)
use sp1_sdk::{ProverClient, SP1Stdin};

let client = ProverClient::new();
let mut stdin = SP1Stdin::new();
stdin.write(&chain_data);

let proof = client.prove(&PROGRAM_ELF, stdin).run()?;

// SP1 Verifier (é“¾ä¸Šåˆçº¦)
// Solana: éƒ¨ç½² SP1 Verifier Program
// EVM: éƒ¨ç½² SP1 Verifier Contract (Groth16Verifier.sol)
```

---

## 8. æ€§èƒ½æŒ‡æ ‡

### 8.1 é¢„æœŸæ€§èƒ½

- **è¯æ˜ç”Ÿæˆæ—¶é—´**: 10-60 ç§’ (å–å†³äº SP1 zkVM ä¼˜åŒ–)
- **è·¨é“¾æ€»æ—¶å»¶**: 1-3 åˆ†é’Ÿ
- **Gas æˆæœ¬**:
  - EVM éªŒè¯ proof: ~200k-500k gas
  - Solana éªŒè¯ proof: ~50k-100k compute units
- **ååé‡**: 10-50 TPS (å— relayer å¹¶å‘èƒ½åŠ›é™åˆ¶)

### 8.2 ä¼˜åŒ–æ–¹å‘

1. **æ‰¹é‡è¯æ˜**: å°†å¤šç¬”è®¢å•èšåˆä¸ºä¸€ä¸ª ZK proof
2. **é€’å½’è¯æ˜**: ä½¿ç”¨ SP1 é€’å½’èƒ½åŠ›å‹ç¼©è¯æ˜å¤§å°
3. **é“¾ä¸‹æ•°æ®**: å°†å¤§å‹ merkle proof å­˜å‚¨åœ¨ IPFS
4. **å¹¶è¡Œ relayer**: è¿è¡Œå¤šä¸ª relayer èŠ‚ç‚¹æé«˜åå

---

## 9. å¼€å‘è·¯çº¿å›¾

### Phase 1: æ ¸å¿ƒåè®® (4-6 å‘¨)
- [ ] Solana Program åŸºç¡€æ¡†æ¶ (Anchor)
- [ ] EVM Contract åŸºç¡€æ¡†æ¶ (Hardhat)
- [ ] SP1 zkVM ç¨‹åºå¼€å‘
- [ ] è½»å®¢æˆ·ç«¯å®ç°
- [ ] æœ¬åœ°æµ‹è¯•ç¯å¢ƒæ­å»º

### Phase 2: Relayer æœåŠ¡ (3-4 å‘¨)
- [ ] äº‹ä»¶ç›‘å¬æ¨¡å—
- [ ] SP1 è¯æ˜ç”Ÿæˆé›†æˆ
- [ ] äº¤æ˜“æäº¤é€»è¾‘
- [ ] è¶…æ—¶ç›‘æ§

### Phase 3: é›†æˆæµ‹è¯• (2-3 å‘¨)
- [ ] ç«¯åˆ°ç«¯è·¨é“¾æµ‹è¯•
- [ ] è¶…æ—¶å›æ»šæµ‹è¯•
- [ ] å¹¶å‘å‹åŠ›æµ‹è¯•
- [ ] å®‰å…¨å®¡è®¡å‡†å¤‡

### Phase 4: æµ‹è¯•ç½‘éƒ¨ç½² (2 å‘¨)
- [ ] Solana Devnet éƒ¨ç½²
- [ ] Arbitrum Sepolia éƒ¨ç½²
- [ ] å…¬å¼€æµ‹è¯•ä¸ Bug ä¿®å¤

### Phase 5: ä¸»ç½‘å‡†å¤‡ (3-4 å‘¨)
- [ ] ç¬¬ä¸‰æ–¹å®‰å…¨å®¡è®¡
- [ ] Bug Bounty è®¡åˆ’
- [ ] æ–‡æ¡£ä¸ SDK
- [ ] ä¸»ç½‘éƒ¨ç½²

---

## 10. é£é™©è¯„ä¼°

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|--------|------|------|---------|
| SP1 zkVM ä¸ç¨³å®š | é«˜ | ä¸­ | æ·±åº¦æµ‹è¯• + å¤‡ç”¨æ–¹æ¡ˆ (è½»å®¢æˆ·ç«¯) |
| Gas æˆæœ¬è¿‡é«˜ | ä¸­ | ä¸­ | æ‰¹é‡è¯æ˜ + é€’å½’å‹ç¼© |
| Relayer ä¸­å¿ƒåŒ– | ä¸­ | é«˜ | å¼€æ”¾ relayer + ç»æµæ¿€åŠ± |
| æ™ºèƒ½åˆçº¦æ¼æ´ | é«˜ | ä½ | å¤šè½®å®¡è®¡ + å½¢å¼åŒ–éªŒè¯ |
| è·¨é“¾æ—¶å»¶è¿‡é•¿ | ä½ | ä¸­ | ä¼˜åŒ– SP1 + å¹¶è¡Œå¤„ç† |

---

## 11. å…³é”®åˆ›æ–°ç‚¹

### 11.1 ZK è¯æ˜çš„æ­£ç¡®åº”ç”¨

**ä¼ ç»Ÿè¯¯è§£**: ZK è¯æ˜éœ€è¦æºé“¾ç”Ÿæˆ  
**æ­£ç¡®è®¾è®¡**: Relayer ç”ŸæˆçŠ¶æ€éªŒè¯è¯æ˜

- Relayer è¯æ˜çš„æ˜¯"æºé“¾çŠ¶æ€æ»¡è¶³æ¡ä»¶"ï¼Œè€Œé"Relayer åšäº†ä»€ä¹ˆ"
- é€šè¿‡ Merkle è¯æ˜ç¡®ä¿çŠ¶æ€æ•°æ®çœŸå®æ€§
- é€šè¿‡è½»å®¢æˆ·ç«¯ç¡®ä¿çŠ¶æ€æ ¹æ¥è‡ªæºé“¾
- æ•°å­¦ä¿è¯æ— æ³•ä¼ªé€ æœ‰æ•ˆè¯æ˜

### 11.2 è¶…æ—¶å›æ»šæœºåˆ¶

**æ ¸å¿ƒè®¾è®¡**: è¶…æ—¶å³å¤±è´¥ï¼Œç”¨æˆ·è‡ªä¸»é€€æ¬¾

- æºé“¾åªéœ€æ£€æŸ¥æ—¶é—´ï¼Œæ— éœ€æŸ¥è¯¢ç›®æ ‡é“¾
- çŠ¶æ€æœºç¡®ä¿æœ‰ä¸”åªæœ‰ä¸€æ–¹æˆåŠŸ
- é˜²æ­¢èµ„é‡‘æ°¸ä¹…é”å®š

### 11.3 åŒå‘å¯¹ç§°æ¶æ„

- ä¸¤æ¡é“¾é€»è¾‘å®Œå…¨å¯¹ç§°
- ç»Ÿä¸€çš„åè®®æµç¨‹
- ç›¸åŒçš„å®‰å…¨ä¿è¯

### 11.4 ç»æµæ¿€åŠ±è®¾è®¡

- Relayer ç«äº‰æ¨¡å¼
- æ‰‹ç»­è´¹åŠ¨æ€è°ƒæ•´
- è´¨æŠ¼æƒ©ç½šæœºåˆ¶

---

## 12. æ€»ç»“

### 12.1 ç³»ç»Ÿä¼˜åŠ¿

1. **å®‰å…¨æ€§**: ZK è¯æ˜ + è½»å®¢æˆ·ç«¯ï¼Œæ— éœ€ä¿¡ä»»ç¬¬ä¸‰æ–¹
2. **å¯ç”¨æ€§**: è¶…æ—¶å›æ»šç¡®ä¿èµ„é‡‘å®‰å…¨
3. **æ•ˆç‡**: é“¾ä¸‹è¯æ˜ç”Ÿæˆï¼Œé“¾ä¸Šå¿«é€ŸéªŒè¯
4. **å¯æ‰©å±•æ€§**: æ”¯æŒä»»æ„ä»£å¸å¯¹ï¼Œæ‰¹é‡å¤„ç†ä¼˜åŒ–
5. **ç»æµæ€§**: ç«äº‰æ€§ relayer ç½‘ç»œï¼Œè´¹ç”¨å¸‚åœºåŒ–

### 12.2 æ ¸å¿ƒä¿è¯

- **åŸå­æ€§**: é€šè¿‡çŠ¶æ€æœºç¡®ä¿æ“ä½œçš„åŸå­æ€§
- **ä¸å¯ä¼ªé€ **: ZK è¯æ˜ä¿è¯çŠ¶æ€éªŒè¯çš„çœŸå®æ€§
- **é˜²åŒèŠ±**: è®¢å•çŠ¶æ€æœºé˜²æ­¢é‡å¤å¤„ç†
- **é˜²æ°¸ä¹…é”å®š**: è¶…æ—¶æœºåˆ¶å…è®¸ç”¨æˆ·è‡ªä¸»é€€æ¬¾
- **ç»æµæ¿€åŠ±**: Relayer æœ‰åŠ¨åŠ›ç»´æŠ¤ç³»ç»Ÿæ­£å¸¸è¿è¡Œ

### 12.3 æŠ€æœ¯äº®ç‚¹

- **SP1 zkVM**: é€šç”¨ ZK è™šæ‹Ÿæœºï¼Œæ”¯æŒä»»æ„ Rust è®¡ç®—
- **è½»å®¢æˆ·ç«¯**: é“¾ä¸ŠéªŒè¯è·¨é“¾çŠ¶æ€ï¼Œæ— éœ€å®Œæ•´èŠ‚ç‚¹
- **çŠ¶æ€æœºè®¾è®¡**: å®Œå–„çš„è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **è¶…æ—¶æœºåˆ¶**: åˆ›æ–°çš„æ•…éšœæ¢å¤æ–¹æ¡ˆ
- **åŒå‘å¯¹ç§°**: ä¼˜é›…çš„åè®®è®¾è®¡

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-10-31  
**åŸºäºæ–‡æ¡£**: 
- `01-è·¨é“¾æ¡¥æŠ€æœ¯æ¶æ„è®¾è®¡.md`
- `02-è¶…æ—¶å›æ»šä¸æ•…éšœæ¢å¤åè®®.md`
- `03-SP1_zkVMåŸç†ä¸åº”ç”¨.md`
- `04-ZKè¯æ˜ä¿¡ä»»æ¨¡å‹ä¸å®‰å…¨æ€§.md`
